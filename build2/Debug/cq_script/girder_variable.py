import cadquery as cq

# ============================================================================
# 变截面箱梁建模脚本
# 依据图纸：梁截面 I-I、II-II、III-III
# ============================================================================

# === 全局参数 ===
L = 31500.0       # 梁总长 (mm)
HALF_L = L / 2    # 半跨长 15750mm

# === 沿梁长方向的关键位置 (从梁端向跨中，单侧) ===
# 梁端 -> 1300mm (III-III 段) -> 854mm (过渡到 II-II) -> 1646mm (过渡到 I-I)
X_END = 0.0                    # 梁端面
X_III_END = 1300.0             # III-III 截面段结束 (距梁端 1300mm)
X_II_END = 1300.0 + 854.0      # II-II 截面段结束 (距梁端 2154mm)
X_I_START = X_II_END + 1646.0  # I-I 截面开始 (距梁端 3800mm)

# ============================================================================
# 1. 三种截面几何参数 (Y 为水平半宽，Z 为高度)
# ============================================================================

def section_I_I():
    """
    梁截面 I-I (跨中标准截面)
    依据第一张图纸尺寸
    """
    # 外轮廓 (对称，只列右半 + 左半关键点)
    outer = [
        (0, 0),              # 底面中心
        (2700, 0),           # 底板右端
        (2700 + 2515/4, 2515),  # 腹板外坡拐点 (斜率 1:4)
        (6300, 2815),        # 悬臂板下表面端点
        (6300, 3032),        # 桥面右上角
        (-6300, 3032),       # 桥面左上角
        (-6300, 2815),       # 悬臂板下表面端点 (左)
        (-2700 - 2515/4, 2515), # 腹板外坡拐点 (左)
        (-2700, 0),          # 底板左端
    ]
    # 内轮廓
    inner = [
        (0, 270),            # 内腔底面中心
        (2171, 270),         # 下梗腋起点
        (2171 + 300, 270 + 300),  # 下梗腋 R300 拐点
        (2171 + 300 + 1360/4, 270 + 300 + 1360),  # 上梗腋下拐点
        (1911, 2430),        # 顶板内角
        (-1911, 2430),       # 顶板内角 (左)
        (-2171 - 300 - 1360/4, 270 + 300 + 1360),  # 上梗腋下拐点 (左)
        (-2171 - 300, 270 + 300),  # 下梗腋 R300 拐点 (左)
        (-2171, 270),        # 下梗腋起点 (左)
    ]
    return outer, inner

def section_II_II():
    """
    梁截面 II-II (过渡段截面)
    依据第三张图 1/2 II-II 截面
    """
    # 外轮廓
    outer = [
        (0, 0),              # 底面中心
        (2700, 0),           # 底板右端
        (2700 + 2515/4, 2515),  # 腹板外坡拐点
        (6300, 2815),        # 悬臂板下表面端点
        (6300, 3015),        # 桥面右上角 (总高 3015)
        (-6300, 3015),       # 桥面左上角
        (-6300, 2815),       # 悬臂板下表面端点 (左)
        (-2700 - 2515/4, 2515), # 腹板外坡拐点 (左)
        (-2700, 0),          # 底板左端
    ]
    # 内轮廓 (依据图中标注)
    inner = [
        (0, 487),            # 内腔底面 (底板厚 487)
        (1760, 487),         # 下梗腋起点
        (1760 + 300, 487 + 300),  # 下梗腋 R300
        (1760 + 300 + (2445-1760-300), 487 + 300 + (1911-487-300)),  # 腹板内坡
        (2445, 2430 - 50),   # 上梗腋 R50 起点
        (-2445, 2430 - 50),  # 上梗腋 R50 起点 (左)
        (-1760 - 300 - (2445-1760-300), 487 + 300 + (1911-487-300)),  # 腹板内坡 (左)
        (-1760 - 300, 487 + 300),  # 下梗腋 R300 (左)
        (-1760, 487),        # 下梗腋起点 (左)
    ]
    return outer, inner

def section_III_III():
    """
    梁截面 III-III (梁端截面)
    依据第三张图 1/2 III-III 截面
    """
    # 外轮廓
    outer = [
        (0, 0),              # 底面中心
        (2700, 0),           # 底板右端
        (2700 + 2515/4, 2515),  # 腹板外坡拐点
        (6300, 2815),        # 悬臂板下表面端点
        (6300, 3015),        # 桥面右上角 (总高 3015)
        (-6300, 3015),       # 桥面左上角
        (-6300, 2815),       # 悬臂板下表面端点 (左)
        (-2700 - 2515/4, 2515), # 腹板外坡拐点 (左)
        (-2700, 0),          # 底板左端
    ]
    # 内轮廓 (依据图中标注)
    inner = [
        (0, 600),            # 内腔底面 (底板厚 600)
        (797 + 300, 600),    # 下梗腋起点 (约 1097)
        (797 + 300 + 300, 600 + 300),  # 下梗腋 R300
        (2255, 2460 - 50),   # 上梗腋 R50 起点
        (-2255, 2460 - 50),  # 上梗腋 R50 起点 (左)
        (-797 - 300 - 300, 600 + 300),  # 下梗腋 R300 (左)
        (-797 - 300, 600),   # 下梗腋起点 (左)
    ]
    return outer, inner

# ============================================================================
# 2. 截面生成辅助函数
# ============================================================================

def make_wire(outer_pts, inner_pts):
    """生成带内孔的闭合截面 Wire"""
    # 外轮廓
    outer_wp = cq.Workplane("YZ").polyline(outer_pts).close()
    # 内轮廓
    inner_wp = cq.Workplane("YZ").polyline(inner_pts).close()
    # 切割形成带孔截面
    return outer_wp.cut(inner_wp)

# ============================================================================
# 3. 自定义边选择器 (用于倒角)
# ============================================================================

class XEdgeByZ(cq.Selector):
    """选择平行于 X 轴且 Z 坐标在容差范围内的边"""
    def __init__(self, target_z, tol=5.0):
        self.target_z = target_z
        self.tol = tol

    def filter(self, objectList):
        result = []
        for obj in objectList:
            if isinstance(obj, cq.Edge) and obj.geomType() == "LINE":
                if abs(obj.tangentAt(0).x) > 0.99:
                    if abs(obj.Center().z - self.target_z) < self.tol:
                        result.append(obj)
        return result

# ============================================================================
# 4. 生成变截面实体
# ============================================================================

# 获取三种截面的轮廓点
outer_I, inner_I = section_I_I()
outer_II, inner_II = section_II_II()
outer_III, inner_III = section_III_III()

# 生成截面 Wire
wire_I = make_wire(outer_I, inner_I)
wire_II = make_wire(outer_II, inner_II)
wire_III = make_wire(outer_III, inner_III)

# 在 X 方向不同位置放置截面 (半跨，从梁端到跨中)
# 位置对应：梁端 (0) -> III-III 结束 -> II-II 结束 -> I-I 开始 -> 跨中
sections_half = [
    wire_III.transformed(offset=(0, 0, 0)),                          # 梁端
    wire_III.transformed(offset=(X_III_END, 0, 0)),                  # III-III 段结束
    wire_II.transformed(offset=(X_II_END, 0, 0)),                    # II-II 段结束
    wire_I.transformed(offset=(X_I_START, 0, 0)),                    # I-I 开始
    wire_I.transformed(offset=(HALF_L, 0, 0)),                       # 跨中
]

# 使用 loft 放样生成半跨实体
half_solid = cq.Solid.loft(sections_half)

# 镜像生成完整梁 (关于 X=0 平面对称)
full_solid = half_solid.mirror(cq.Plane(cq.Vector(0, 0, 0), cq.Vector(1, 0, 0)))

# ============================================================================
# 5. 添加纵向倒角 (可选，根据图纸 R300、R50 等)
# ============================================================================

girder = full_solid

# 注意：变截面模型的倒角需要更复杂的选择器，此处暂不添加
# 如需添加，可基于面的法向和位置进行选择

# ============================================================================
# 输出结果
# ============================================================================

result = girder

if 'show_object' in globals():
    show_object(result, name="Variable_Box_Girder", options={"color": (180, 180, 180)})

# 打印关键信息
print(f"梁总长：{L} mm")
print(f"III-III 段：0 ~ {X_III_END} mm (长度 {X_III_END} mm)")
print(f"II-II 过渡段：{X_III_END} ~ {X_II_END} mm (长度 {X_II_END - X_III_END} mm)")
print(f"I-I 过渡段：{X_II_END} ~ {X_I_START} mm (长度 {X_I_START - X_II_END} mm)")
print(f"I-I 标准段：{X_I_START} ~ {HALF_L} mm (长度 {HALF_L - X_I_START} mm)")
