# SHX 字符排进算法对比分析

本文件详细对比了本项目 (`ShxTextGenerator`) 实现的字符排进算法与基础解析库 (`shxparser`) 原生算法的区别。

## 1. 核心差异总结

| 特性 | shxparser (原生实现) | ShxTextGenerator (本项目优化实现) |
| :--- | :--- | :--- |
| **包围盒计算依据** | 所有绘图命令的**终点坐标** (含 `MoveTo`) | 仅限可见墨迹的**几何形状** (Lines, Arcs)，排除 `MoveTo` |
| **圆弧 (Arc) 处理** | 仅统计起始点和终点，**忽略圆弧凸起 (Bulge)** | **精确计算**圆弧几何体的物理包围盒，包含凸起部分 |
| **线段 (Line) 处理** | 仅统计终点 (忽略起点) | 同时统计起点和终点，并跟踪笔触轨迹 |
| **字符推进量 (Advance)** | `MaxX - MinX` (原始包围盒宽度) | **可见宽度 × 1.1** (增加 10% 呼吸间距) |
| **极细字符处理** | 宽度可能为 0 (导致重叠) | **特殊保护**：前后各增加 2.0 单位间距，确保居中且不重叠 |
| **对齐方式** | 依赖字体定义的原始坐标系 | **强制归一化**：将可见墨迹的最左端移至光标位置 |

## 2. 详细分析

### 2.1 包围盒计算 (Bounding Box Computation)

* **shxparser**:
    其计算逻辑简单地遍历所有命令的 `endPoint`。这导致了两个主要问题：
    1. **圆弧误差**：对于像 'S' 这样由圆弧构成的字符，如果圆弧的凸起部分超出了起点和终点的范围，原生算法无法检测到，导致计算出的宽度小于实际宽度。**这是导致 'S' 与后续字符重叠的根本原因。**
    2. **隐形宽度**：包含 `MoveTo` 命令（通常用于字体内部定位）的字符会被计算出比实际墨迹更大的宽度，或者如果 `MoveTo` 跳回原点，会导致错误的最小/最大值。

* **ShxTextGenerator**:
    采用了极其严格的**所见即所得 (Ink-Only)** 策略：
  * **排除干扰**：显式忽略 `MoveTo` 对包围盒的贡献，只关心实际画出的线条。
  * **精确几何**：对于 `ArcTo`，利用 OpenCASCADE 的 `GC_MakeArcOfCircle` 和 `BRepBndLib` 计算真实的几何边界。这确保了无论圆弧如何弯曲，其最外缘都会被界定为字符边界。
  * **笔触跟踪**：引入 `currentPen` 状态，确保每一段几何图形的起点（不仅仅是终点）都被纳入计算。

### 2.2 字符推进 (Character Advance)

* **shxparser**:
    `Advance = GlyphWidth`。默认字符之间没有额外间距。如果字体设计本身没有包含足够的右侧空白（Right Side Bearing），字符将会紧挨着排列，视觉上非常拥挤甚至粘连。

* **ShxTextGenerator**:
    采用 **对数间隙 (Logarithmic Spacing)** 策略：
  * **普通字符**：`Advance = InkWidth * 1.1`。额外增加 10% 的空白，提供了均匀的视觉呼吸感。
  * **零宽字符 (如 'l')**：检测到宽度极小时，不使用乘法放大，而是采用 **对称填充**：`Advance = 2.0 + Width + 2.0`。这确保了极细字符周围有固定的安全空间，且视觉居中。

### 2.3 对齐与归一化 (Alignment & Normalization)

* **shxparser**:
    直接使用字体的坐标数据绘制。如果字体设计者将字符绘制在坐标 `(10, 0)` 处，那么字符就会凭空向右偏移 10 个单位。这依赖于字体文件的规范性。

* **ShxTextGenerator**:
    实施 **左对齐归一化**。计算出字符可见墨迹的 `MinX`，并在绘制时减去该值。这意味着无论字体内部如何定义坐标，字符的**第一个可见像素**永远紧贴当前光标位置开始。所有的空白都由我们的算法（如 10% Padding）显式控制，而不是依赖字体文件的隐式定义。

## 3. 结论

`shxparser` 的实现更倾向于作为一种**基础的数据解析器**，忠实地反映了 SHX 文件中的命令数据，但作为**渲染引擎**由显不足，特别是对于非单线体或包含复杂曲线的字体。

本项目 (`ShxTextGenerator`) 通过引入**几何级包围盒计算**和**自适应排版策略**，修复了原生算法在视觉呈现上的固有缺陷，实现了更健壮、美观且符合现代排版习惯的渲染效果。
